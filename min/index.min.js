!function(window){function Danmaku(e,t){var n=t.getContext("2d");this.value=e.value,this.time=e.time,this.init=function(){this.speed=e.speed,this.speed+=this.speed?e.value.length/100:0,this.fontSize=e.fontSize,this.color=e.color,this.range=e.range,this.opacity=e.opacity;var n=document.createElement("span");n.style.position="absolute",n.style.whiteSpace="nowrap",n.style.font="bold "+this.fontSize+'px "microsoft yahei", sans-serif',n.innerText=e.value,n.textContent=e.value,document.body.appendChild(n),this.width=n.clientWidth,document.body.removeChild(n),this.x=t.width,0===this.speed&&(this.x=(this.x-this.width)/2),this.actualX=t.width,this.y=this.range[0]*t.height+(this.range[1]-this.range[0])*t.height*Math.random()},this.draw=function(){n.shadowColor="rgba(0,0,0,"+this.opacity+")",n.shadowBlur=2,n.font=this.fontSize+'px "microsoft yahei", sans-serif',/rgb\(/.test(this.color)?n.fillStyle="rgba("+this.color.split("(")[1].split(")")[0]+","+this.opacity+")":n.fillStyle=this.color,n.fillText(this.value,this.x,this.y)}}function DanmakuPlayer(e,t,n){this.className=e,this.videoContainer=document.getElementsByClassName(this.className)[t],this.i=t,this.n=n,this.defaults={opacity:1,fontSize:24,speed:2,range:[0,1],color:"white"},this.store=[]}function _requestFullscreen(e){try{e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen?e.msRequestFullscreen():e.webkitRequestFullscreen()}catch(e){console.error("Your browser doesn't support requestFullscreen")}}function _exitFullscreen(){try{document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():document.webkitExitFullscreen()}catch(e){console.error("Your browser doesn't support exitFullscreen")}}function _formatTime(e){function t(e){return e<10&&(e="0"+e),e}var n=parseInt(e/60),a=parseInt(e%60);return t(n)+":"+t(a)}function _changePlayPause(e){return function(){var t=document.getElementsByClassName("video")[e],n=document.getElementsByClassName("playpause")[e];t.paused||t.ended?(n.className="command playpause pause",t.play()):(n.className="command playpause play",t.pause())}}DanmakuPlayer.prototype.setDefaults=function(e){for(var t in e)this.defaults.hasOwnProperty(t)&&(this.defaults[t]=e[t])},DanmakuPlayer.prototype.initialize=function(e,t){e?this.createVideo(e):console.error("url must be specified"),this.createPlayingComponents(),this.setPlaying(),this.setVolume(),this.createDanmakuComponents(),this.sendDanmaku(t),this.loadDanmaku(t),this.createSmallVideo(20,20),this.setSmallVideo(),this.dragSmallVideo(),this.resizeSmallVideo(),this.closeSmallVideo()},DanmakuPlayer.prototype.createVideo=function(e){var t=document.createElement("div"),n=document.createElement("video"),a=document.createElement("canvas"),s=document.createElement("div");t.className="play-block",n.className="video",a.className="danmaku-block",s.className="video-block",e?n.innerHTML="<source src='"+e+"'>":console.error("url must be specified"),s.appendChild(a),s.appendChild(n),t.appendChild(s),this.videoContainer.appendChild(t)},DanmakuPlayer.prototype.createPlayingComponents=function(){var e=this.i,t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div"),s=document.createElement("button"),i=document.createElement("div"),o=document.createElement("button"),l=document.createElement("input"),m=document.createElement("div"),d=document.createElement("button"),r=document.createElement("button"),c=document.createElement("button"),u=document.getElementsByClassName("play-block")[e],p=document.getElementsByClassName("video")[e];t.className="play-info",n.className="progress-bar",a.className="command-block",s.className="command playpause play",i.className="volume-block",o.className="command volume on",l.className="volume-range",m.className="time",d.className="command danmaku",r.className="command full",c.className="command popup",l.setAttribute("min","0"),l.setAttribute("max","1"),l.setAttribute("step","0.05"),l.setAttribute("type","range"),n.innerHTML="<span class='progress'></span>",m.innerHTML="<span class='present-time'>00:00</span>/<span class='total-time'>00:00</span>",c.addEventListener("click",function(){var t=document.getElementsByClassName("small-video")[0];DanmakuPlayer.prototype.n=e,t.innerHTML=p.innerHTML,t.load(),t.pause(),p.play(),p.currentTime=0,t.play(),s.className="command playpause pause"}),p.addEventListener("click",_changePlayPause(this.i,this.n)),s.addEventListener("click",_changePlayPause(this.i,this.n)),s.addEventListener("click",function(){var t=document.getElementsByClassName("small-video")[0];DanmakuPlayer.prototype.n===e&&(t.paused||t.ended?t.play():t.pause())}),r.addEventListener("click",function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?(_exitFullscreen(),t.style.position="relative",t.style.zIndex="0",r.setAttribute("class","full command")):(_requestFullscreen(p),t.style.position="fixed",t.style.zIndex="2147483647",r.setAttribute("class","exit-full command"))}),document.addEventListener("fullscreenchange",function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||(t.style.position="relative",t.style.zIndex="0",r.setAttribute("class","full command"))}),i.appendChild(o),i.appendChild(l),a.appendChild(s),a.appendChild(i),a.appendChild(m),a.appendChild(r),a.appendChild(d),a.appendChild(c),t.appendChild(n),t.appendChild(a),u.appendChild(t)},DanmakuPlayer.prototype.setPlaying=function(){var e=this.i,t=document.getElementsByClassName("video")[e];document.getElementsByClassName("playpause")[e];t.addEventListener("canplaythrough",function(){document.getElementsByClassName("total-time")[e].innerHTML=_formatTime(t.duration)}),t.addEventListener("progress",function(){}),t.addEventListener("timeupdate",function(){var n=document.getElementsByClassName("present-time")[e],a=document.getElementsByClassName("progress")[e];n.innerHTML=_formatTime(t.currentTime),a.style.width=t.currentTime/t.duration*100+"%"})},DanmakuPlayer.prototype.setVolume=function(){var e=document.getElementsByClassName("volume-range")[this.i],t=document.getElementsByClassName("volume")[this.i],n=document.getElementsByClassName("video")[this.i];e.addEventListener("change",function(){n.volume=e.value}),t.addEventListener("click",function(){n.muted?t.className="command volume on":t.className="command volume off",n.muted=!n.muted})},DanmakuPlayer.prototype.createDanmakuComponents=function(){var e=this.i,t=document.createElement("div"),n=document.createElement("input"),a=document.createElement("button"),s=document.createElement("button"),i=document.createElement("div"),o=document.getElementsByClassName("play-block")[e],l=document.getElementsByClassName("danmaku")[e];t.className="danmaku-command",n.className="danmaku-input",a.className="command danmaku-sender",s.className="command danmaku-settings",i.className="danmaku-style",n.type="text",n.placeholder="输入弹幕",i.innerHTML="<form>位置<br><input type='radio' name='range' value='[0, 1]'>全屏<input type='radio' name='range' value='[0, 0.5]'>上方<input type='radio' name='range' value='[0.5, 1]'>下方</form><form>速度<br><input type='radio' name='speed' value='3'>快速<input type='radio' name='speed' value='2'>普通<input type='radio' name='speed' value='1'>慢速<input type='radio' name='speed' value='0'>固定</form><form>颜色<br><input type='radio' name='color' value='white'>白<input type='radio' name='color' value='red'>红<input type='radio' name='color' value='orange'>橙<input type='radio' name='color' value='yellow'>黄<input type='radio' name='color' value='green'>绿<input type='radio' name='color' value='blue'>蓝<input type='radio' name='color' value='purple'>紫</form>",t.appendChild(n),t.appendChild(a),t.appendChild(s),t.appendChild(i),o.appendChild(t),l.addEventListener("click",function(){"block"===t.style.display?t.style.display="none":t.style.display="block"}),s.addEventListener("click",function(){"block"===i.style.display?i.style.display="none":i.style.display="block"})},DanmakuPlayer.prototype.sendDanmaku=function(src,func){function sendDanmaku(){var video=document.getElementsByClassName("video")[i],input=document.getElementsByClassName("danmaku-input")[i],time=video.currentTime.toFixed(1),item=defaults,rangeRadios=document.getElementsByName("range"),speedRadios=document.getElementsByName("speed"),colorRadios=document.getElementsByName("color");if("object"==typeof src)if(Array.isArray(JSON.parse(src)))var danmakus=JSON.parse(src);else console.error("the format of danmaku is not correct");else if(localStorage.getItem("danmakus"))danmakus=JSON.parse(localStorage.getItem("danmakus"));else{danmakus=[];for(var j=0;j<document.getElementsByClassName("video").length;j++)danmakus.push([])}for(j=3*i;j<3*(i+1);j++)rangeRadios[j].checked&&(item.range=eval(rangeRadios[j].value));for(j=4*i;j<4*(i+1);j++)speedRadios[j].checked&&(item.speed=eval(speedRadios[j].value));for(j=7*i;j<7*(i+1);j++)colorRadios[j].checked&&(item.color=colorRadios[j].value);item.value=input.value,item.time=time,danmakus[i].push(item),"object"==typeof src?src=JSON.stringify(danmakus):localStorage.setItem("danmakus",JSON.stringify(danmakus)),store[Object.keys(store).length]=new Danmaku(item,canvas),input.value="","function"==typeof func&&func()}var i=this.i,store=this.store,defaults=this.defaults,canvas=document.getElementsByClassName("danmaku-block")[i],input=document.getElementsByClassName("danmaku-input")[i],send=document.getElementsByClassName("danmaku-sender")[i];input.addEventListener("keyup",function(e){13===e.keyCode&&sendDanmaku()}),send.addEventListener("click",sendDanmaku)},DanmakuPlayer.prototype.loadDanmaku=function(e){function t(){l=s.currentTime,m.clearRect(0,0,i.width,i.height),function(){for(var e in n){var t=n[e];t&&!t.disabled&&l>=t.time&&(t.inited||(t.init(),t.inited=!0),t.x-=t.speed,0===t.speed?t.actualX-=2:t.actualX=t.x,t.actualX<-1*t.width&&(t.x=t.actualX,t.disabled=!0),t.draw())}}(),o||requestAnimationFrame(t)}var n=this.store,a=this.i,s=document.getElementsByClassName("video")[a],i=document.getElementsByClassName("danmaku-block")[a],o=!0,l=s.currentTime,m=i.getContext("2d");if(i.width=i.offsetWidth,i.height=i.offsetHeight,"object"==typeof e)if(Array.isArray(JSON.parse(e)))var d=JSON.parse(e);else console.error("the format of danmaku is not correct");else if(localStorage.getItem("danmakus"))d=JSON.parse(localStorage.getItem("danmakus"));else{d=[];for(var r=0;r<document.getElementsByClassName("video").length;r++)d.push([])}d[a].forEach(function(e,t){n[t]=new Danmaku(e,i)}),s.addEventListener("play",function(){o=!1,t()}),s.addEventListener("pause",function(){o=!0}),s.addEventListener("seeked",function(){l=s.currentTime,m.clearRect(0,0,i.width,i.height);for(var e in n){var t=n[e];t&&(t.disabled=!0,l<t.time?t.inited=null:t.disabled=!0)}})},DanmakuPlayer.prototype.createSmallVideo=function(e,t,n){if(this.i===this.n){var a=document.createElement("div"),s=document.createElement("button"),i=document.createElement("button"),o=document.createElement("button"),l=document.createElement("video");a.className="small-video-container",s.className="drag-bar",i.className="resize-bar",o.className="close",l.className="small-video","number"==typeof e&&"number"==typeof t?(a.style.top=window.innerHeight-200-e+"px",a.style.left=window.innerWidth-320-t+"px"):console.error("bottom and right aren't specified"),s.innerHTML="move",i.innerHTML="resize",o.innerHTML="close","function"==typeof n&&n(this.n),a.appendChild(s),a.appendChild(i),a.appendChild(o),a.appendChild(l),document.body.appendChild(a)}},DanmakuPlayer.prototype.setSmallVideo=function(){if(this.i===this.n){var e=document.getElementsByClassName("small-video-container")[0],t=document.getElementsByClassName("video")[0];window.addEventListener("scroll",function(){t.getBoundingClientRect().top+t.offsetHeight<0?e.style.display="block":e.style.display="none"})}},DanmakuPlayer.prototype.dragSmallVideo=function(e){if(this.i===this.n){var t,n,a,s,i=document.getElementsByClassName("small-video-container")[0];document.getElementsByClassName("drag-bar")[0].addEventListener("mousedown",o);function o(e){e=e||window.event,n=e.clientX,s=e.clientY,window.addEventListener("mousemove",l),window.addEventListener("mouseup",m)}function l(e){e=e||window.event,t=n-e.clientX,a=s-e.clientY,n=e.clientX,s=e.clientY,i.style.top=i.offsetTop-a+"px",i.style.left=i.offsetLeft-t+"px"}function m(){window.removeEventListener("mouseup",m),window.removeEventListener("mousemove",l),"function"==typeof e&&e()}}},DanmakuPlayer.prototype.resizeSmallVideo=function(e){if(this.i===this.n){var t,n,a=document.getElementsByClassName("small-video-container")[0],s=document.getElementsByClassName("resize-bar")[0],i=document.getElementsByClassName("small-video")[0];s.addEventListener("mousedown",o);function o(e){e=e||window.event,t=e.clientX,n=i.offsetWidth,window.addEventListener("mousemove",l),window.addEventListener("mouseup",m)}function l(e){e=e||window.event,i.style.width=n+e.clientX-t+"px",a.style.width=i.style.width,i.style.height=(n+e.clientX-t)/16*9+"px"}function m(){window.removeEventListener("mouseup",m),window.removeEventListener("mousemove",l),"function"==typeof e&&e()}}},DanmakuPlayer.prototype.closeSmallVideo=function(e){if(this.i===this.n){var t=document.getElementsByClassName("close")[0],n=document.getElementsByClassName("small-video")[0];t.addEventListener("click",function(){"hidden"===n.style.visibility?(n.style.visibility="visible",t.innerHTML="close","function"==typeof e&&e()):(n.style.visibility="hidden",t.innerHTML="open")})}},window.GenerateDanmakuPlayers=function(e,t,n){for(var a=[],s=0;s<t;s++)try{a[s]=new DanmakuPlayer(e,s,n||0)}catch(e){console.error("some arguments haven't been specified")}return a}}(window);